<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#6200ee"><meta name="author" content="god23bin"><meta name="copyright" content="god23bin"><meta name="generator" content="Hexo 6.1.0"><meta name="theme" content="hexo-theme-yun"><title>我操作MySQL的惊险一幕 | 方圆-起名字真是个难题</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.2.4/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/mini.global.js"></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script>document.addEventListener("DOMContentLoaded", () => {
  Yun.utils.renderKatex();
});</script><link class="aplayer-style-marker" rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.css"><script class="aplayer-script-marker" src="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.js" defer></script><script class="meting-script-marker" src="https://cdn.jsdelivr.net/npm/meting@1/dist/Meting.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js" defer></script><script src="/js/pjax.js" defer type="module"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#6200ee"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"god23bin.github.io","root":"/","title":["方圆","可方","可圆"],"version":"1.8.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"vendors":{"darken":"https://cdn.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="背景前几天因工作需要，组长给我安排了一个数据清洗的任务。  任务：把 A 表的数据洗到 B 表。  我的第一反应，什么是「洗」？洗数据是什么？洗钱我倒是知道。 不过我不能慌啊，于是问了问组长。 我：组长，把 A 表的数据洗到 B 表是什么意思？ 组长一脸无奈，手捂住脸，恨铁不成钢，然后调整过来，还是很耐心地跟我讲的，大概意思就是我们现在 B 表需要 A 表的数据， A 表中和 B 表中字段含义一样">
<meta property="og:type" content="article">
<meta property="og:title" content="我操作MySQL的惊险一幕">
<meta property="og:url" content="https://god23bin.github.io/posts/thrilling-scene-of-working-with-MySQL/index.html">
<meta property="og:site_name" content="方圆-起名字真是个难题">
<meta property="og:description" content="背景前几天因工作需要，组长给我安排了一个数据清洗的任务。  任务：把 A 表的数据洗到 B 表。  我的第一反应，什么是「洗」？洗数据是什么？洗钱我倒是知道。 不过我不能慌啊，于是问了问组长。 我：组长，把 A 表的数据洗到 B 表是什么意思？ 组长一脸无奈，手捂住脸，恨铁不成钢，然后调整过来，还是很耐心地跟我讲的，大概意思就是我们现在 B 表需要 A 表的数据， A 表中和 B 表中字段含义一样">
<meta property="og:locale">
<meta property="og:image" content="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105825.png">
<meta property="og:image" content="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105833.png">
<meta property="og:image" content="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105838.png">
<meta property="og:image" content="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105843.png">
<meta property="article:published_time" content="2022-10-04T00:02:00.000Z">
<meta property="article:modified_time" content="2022-11-20T13:00:01.530Z">
<meta property="article:author" content="god23bin">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105825.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about/" title="god23bin"><img width="96" loading="lazy" src="https://raw.githubusercontent.com/god23bin/pic-bed/master/img/20220516145418.jpeg" alt="god23bin"><span class="site-author-status" title="今天不学习，明天变垃圾">😆</span></a><div class="site-author-name"><a href="/about/">god23bin</a></div><a class="site-name" href="/about/site.html">方圆-起名字真是个难题</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">30</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">9</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">34</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/god23bin" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="god23bin@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=77844313" title="网易云音乐" target="_blank" style="color:#C10D0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/341183781" title="哔哩哔哩动画" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我喜欢的大佬们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="我的女神天使们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A-%E8%A1%A8"><span class="toc-text">A 表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#B-%E8%A1%A8"><span class="toc-text">B 表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%98%E5%8E%9F%E7%8E%B0%E5%9C%BA"><span class="toc-text">还原现场</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B4%97%E6%95%B0%E6%8D%AE%E6%80%9D%E8%B7%AF"><span class="toc-text">洗数据思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99-SQL-%E6%93%8D%E4%BD%9C"><span class="toc-text">写 SQL 操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/Ajax/" style="font-size: 12px; color: #999">Ajax</a> <a href="/tags/Android/" style="font-size: 16.5px; color: #7391ad">Android</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 25.5px; color: #2680d4">C语言</a> <a href="/tags/ES/" style="font-size: 12px; color: #999">ES</a> <a href="/tags/Element-UI/" style="font-size: 12px; color: #999">Element UI</a> <a href="/tags/HashMap/" style="font-size: 12px; color: #999">HashMap</a> <a href="/tags/Hexo/" style="font-size: 12px; color: #999">Hexo</a> <a href="/tags/Java/" style="font-size: 25.5px; color: #2680d4">Java</a> <a href="/tags/Js/" style="font-size: 12px; color: #999">Js</a> <a href="/tags/Json/" style="font-size: 12px; color: #999">Json</a> <a href="/tags/MySQL/" style="font-size: 12px; color: #999">MySQL</a> <a href="/tags/NLP/" style="font-size: 12px; color: #999">NLP</a> <a href="/tags/Node-js/" style="font-size: 12px; color: #999">Node.js</a> <a href="/tags/Spring/" style="font-size: 12px; color: #999">Spring</a> <a href="/tags/Vue-js/" style="font-size: 12px; color: #999">Vue.js</a> <a href="/tags/jQuery/" style="font-size: 12px; color: #999">jQuery</a> <a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 25.5px; color: #2680d4">入门</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0/" style="font-size: 25.5px; color: #2680d4">函数实现</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 30px; color: #0078e7">前端</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 21px; color: #4d89c0">后端</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#6200ee;"><link itemprop="mainEntityOfPage" href="https://god23bin.github.io/posts/thrilling-scene-of-working-with-MySQL/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="god23bin"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="方圆-起名字真是个难题"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">我操作MySQL的惊险一幕</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2022-10-04 00:02:00" itemprop="dateCreated datePublished" datetime="2022-10-04T00:02:00+00:00">2022-10-04</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2022-11-20 13:00:01" itemprop="dateModified" datetime="2022-11-20T13:00:01+00:00">2022-11-20</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="Word count in article">2k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="Reading time">7m</span></span></span><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span id="busuanzi_value_page_pv"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/MySQL/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">MySQL</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/MySQL/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">MySQL</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>前几天因工作需要，组长给我安排了一个数据清洗的任务。</p>
<blockquote>
<p>任务：把 A 表的数据洗到 B 表。</p>
</blockquote>
<p>我的第一反应，<strong>什么是「洗」？洗数据是什么？</strong>洗钱我倒是知道。</p>
<p>不过我不能慌啊，于是问了问组长。</p>
<p>我：组长，把 A 表的数据洗到 B 表是什么意思？</p>
<p>组长一脸无奈，手捂住脸，恨铁不成钢，然后调整过来，还是很耐心地跟我讲的，大概意思就是我们现在 B 表需要 A 表的数据， A 表中和 B 表中字段含义一样，但是值可能不一样，这就需要我们进行处理，在将 A 表数据搞到 B 表的过程中，把数据搞正确。</p>
<p>基于我理解能力有限，当时并不是很懂所谓的「洗数据」，而且这个 A 表的字段也和 B 表的字段没怎么对上，A 的字段明显多于 B 的字段，某些字段命名也和 B 不一样，但是表达的意思是一样的，该如何洗？</p>
<p>于是疯狂搜索如何洗数据！</p>
<p>我这里就举个例子来说明，分别给出 A 表和 B 表，当然我只列出了一部分字段，现在假设就这么多字段。</p>
<h3 id="A-表"><a href="#A-表" class="headerlink" title="A 表"></a>A 表</h3><p>A 表字段：<code>name, province_id, city_id, area_id, tech_id, crop_id, field_id, create_time, update_time, xxx, yyy, zzz, ... </code></p>
<p><strong>A 表的字段是多于 B 表的</strong>，我需要将 A 表的数据洗到 B 表，<strong>只处理我需要的字段</strong>，不需要的就不用理。</p>
<p>A 表中有 2 万多条记录，B 表我自己插入的有 200 多条记录。</p>
<p>当然，给出 A 表后，还给了个实体模型（JavaBean，Entity，超多种叫法，花里胡哨的）</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> provinceId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> cityId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> areaId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> techId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> cropId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="B-表"><a href="#B-表" class="headerlink" title="B 表"></a>B 表</h3><p>B 表字段：<code>name, province_id, city_id, area_id, mature_id, crop_id, create_time, update_time</code></p>
<h2 id="还原现场"><a href="#还原现场" class="headerlink" title="还原现场"></a>还原现场</h2><p>下面我模拟测试环境中数据库的那两张表，上面是 A 表（2 万多条记录，这里我只模拟了 7 条），下面的 B 表（200 多条记录）。</p>
<p><img src="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105825.png" loading="lazy"></p>
<h3 id="洗数据思路"><a href="#洗数据思路" class="headerlink" title="洗数据思路"></a>洗数据思路</h3><p>首先，我是先找出 A 表中能和 B 表对上意思的字段，然后将 A 表数据全部插入到 B 表中。</p>
<p>于是，我便找出了如下这些字段：</p>
<p><code>name, province_id, city_id, area_id, tech_id, crop_id, update_time</code></p>
<p>之后在 B 表中对新插入的数据进行处理，即<strong>洗数据</strong>。</p>
<h3 id="写-SQL-操作"><a href="#写-SQL-操作" class="headerlink" title="写 SQL 操作"></a>写 SQL 操作</h3><p>主要的 SQL 语句是：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 目标表<span class="token punctuation">(</span>字段<span class="token number">1</span><span class="token punctuation">,</span> 字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">SELECT</span> 字段<span class="token number">1</span><span class="token punctuation">,</span> 字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> 来源表 <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span></code></pre>

<p>于是，便这样操作：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> b<span class="token punctuation">(</span>name<span class="token punctuation">,</span> province_id<span class="token punctuation">,</span> city_id<span class="token punctuation">,</span> area_id<span class="token punctuation">,</span> mature_id<span class="token punctuation">,</span> crop_id<span class="token punctuation">,</span> update_time<span class="token punctuation">)</span> 
<span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> province_id<span class="token punctuation">,</span> city_id<span class="token punctuation">,</span> area_id<span class="token punctuation">,</span> tech_id<span class="token punctuation">,</span> crop_id<span class="token punctuation">,</span> update_time <span class="token keyword">FROM</span> a<span class="token punctuation">;</span></code></pre>

<p>操作是正常的，成功将 A 中 2 万多条记录全部插入到了 B 中。</p>
<p><strong>但是！我漏了一个字段</strong>，就是 <code>create_time</code> 。</p>
<p><img src="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105833.png" loading="lazy"></p>
<p>于是，想着对这个字段进行更新，将 A 中这个字段更新到 B 中。</p>
<p>于是写了一条SQL语句。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> b<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span> <span class="token keyword">SET</span> create_time <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time <span class="token keyword">FROM</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">></span> <span class="token number">1064</span> <span class="token operator">-</span> You have an error <span class="token operator">in</span> your <span class="token keyword">SQL</span> syntax<span class="token punctuation">;</span> <span class="token keyword">check</span> the manual that corresponds <span class="token keyword">to</span> your MySQL server version <span class="token keyword">for</span> the <span class="token keyword">right</span> syntax <span class="token keyword">to</span> <span class="token keyword">use</span> near <span class="token string">'(create_time) SET create_time = (SELECT create_time FROM a)'</span> at line <span class="token number">1</span></code></pre>

<p>噢，看来不能这样更新啊！（一个大嘴巴子过去，写错了还没发现）</p>
<p><strong>换种写法：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> b <span class="token keyword">AS</span> tb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time <span class="token keyword">FROM</span> a<span class="token punctuation">)</span> <span class="token keyword">AS</span> ta <span class="token keyword">SET</span> tb<span class="token punctuation">.</span>create_time <span class="token operator">=</span> ta<span class="token punctuation">.</span>create_time<span class="token punctuation">;</span></code></pre>

<p><strong>可以，噩梦开始了！</strong></p>
<p>更新了非常久，看着十几秒的SQL执行到六七百秒还没执行完，心里着实很慌！眼看着数据库可能会崩，我不得不向我的组长求救了！</p>
<p>这时问题出现了，有人数据库连接不上了，可见这严重性，已经影响到其他人的使用了！</p>
<p><img src="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105838.png" alt="噩梦" loading="lazy"></p>
<p>于是我组长来帮我处理了，想着 kill 掉我的 <code>navicat</code> ，但是 kill 掉还是没效果，毕竟这个 SQL 已经在执行了。</p>
<p>我：能不能重启这个 MySQL 服务？</p>
<p>组长一波连环炮过来了</p>
<p>组长：重启？你知道这个 MySQL 有多少人在用吗？又不只是我们在用，你重启其他人怎么搞？</p>
<p>我哑口无言，心里非常忐忑，想着闯祸了，GG，就看着他操作。没过多久，经过他的一顿操作，终于解决了这个问题。我的心里的一块悬着的大石终于放下了，还好解决了。组长牛逼，救世主！</p>
<p>我：如何解决的？</p>
<p>组长：将这个事务回滚解决的，你更新的 SQL 怎么写的？（努力回想）</p>
<p>于是写出了上面写的 SQL：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> b <span class="token keyword">AS</span> tb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time <span class="token keyword">FROM</span> a<span class="token punctuation">)</span> <span class="token keyword">AS</span> ta <span class="token keyword">SET</span> tb<span class="token punctuation">.</span>create_time <span class="token operator">=</span> ta<span class="token punctuation">.</span>create_time<span class="token punctuation">;</span></code></pre>

<p>组长：你为什么这样写？不应该把子查询写在 <code>SET tb.create_time</code> 后面吗？</p>
<p>我：对啊，我一开始就是把这个子查询写在它后面的，但是提示我语法错误，我就换了一种写法。</p>
<p>组长：那你写写你说提示错误的 SQL。</p>
<p>于是我又丢出来一个 SQL：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> b <span class="token keyword">SET</span> create_time <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time <span class="token keyword">FROM</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><strong>实际上，这条 SQL 也是不行的，子查询返回的结果不止一行，而当前 SET 是更新某一行的。</strong></p>
<p><strong>正确的写法是：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> b <span class="token keyword">AS</span> tb 
<span class="token keyword">SET</span> create_time <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time <span class="token keyword">FROM</span> a <span class="token keyword">AS</span> ta <span class="token keyword">WHERE</span> tb<span class="token punctuation">.</span>id <span class="token operator">=</span> ta<span class="token punctuation">.</span>id <span class="token operator">AND</span> tb<span class="token punctuation">.</span>name <span class="token operator">=</span> ta<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code></pre>

<p><img src="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20221003105843.png" alt="成功更新B表" loading="lazy"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/AlbertFei/archive/2012/12/27/essay.html">博客园-SQL把一个表中数据更新到另一个表的多种方法</a></p>
</blockquote>
<p>最后组长深思，你 B 表已经有 2 万多条记录了，A 表也有 2 万多条记录，你这样更新，每一次都需要子查询查出 A 表的 2 万多条记录，B 也有 2 万多条记录，<strong>这样成笛卡尔积了</strong>，你知道什么是笛卡尔积吧？2 万 × 2 万 &#x3D; 4 亿的记录行了，难怪这么久。</p>
<p>让我重新操作，那么现在我会在原先的 SQL 加上 WHERE 条件，这样写：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> b <span class="token keyword">AS</span> tb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> a<span class="token punctuation">)</span> <span class="token keyword">AS</span> ta 
<span class="token keyword">SET</span> tb<span class="token punctuation">.</span>create_time <span class="token operator">=</span> ta<span class="token punctuation">.</span>create_time
<span class="token keyword">WHERE</span> tb<span class="token punctuation">.</span>id <span class="token operator">=</span> ta<span class="token punctuation">.</span>id <span class="token operator">AND</span> tb<span class="token punctuation">.</span>name <span class="token operator">=</span> ta<span class="token punctuation">.</span>name<span class="token punctuation">;</span></code></pre>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>情况：漏了某一个字段 X，需要将 A 表的这个字段列值更新到 B 表</p>
<p>条件：A 中的 id 字段的值等于 B表中的 id 字段的值 且 A 中的 name 字段的值等于 B 中 name 字段的值（条件为什么这样写？）。</p>
<blockquote>
<p>条件这样写主要是因为 <strong>表和表之间的关联关系</strong> 可能有多个字段，此处只选二个字段，多个依此类推。</p>
</blockquote>
<p>操作：</p>
<ul>
<li>一张表的数据插入到另一张表，可以这样写：</li>
</ul>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 目标表<span class="token punctuation">(</span>字段<span class="token number">1</span><span class="token punctuation">,</span> 字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">SELECT</span> 字段<span class="token number">1</span><span class="token punctuation">,</span> 字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> 来源表 <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span></code></pre>

<ul>
<li>批量更新一张表的某个字段到另一张表，那么 SQL 可以类似这样写：</li>
</ul>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 写法一</span>
<span class="token keyword">UPDATE</span> b <span class="token keyword">AS</span> tb 
<span class="token keyword">SET</span> create_time <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time <span class="token keyword">FROM</span> a <span class="token keyword">AS</span> ta <span class="token keyword">WHERE</span> tb<span class="token punctuation">.</span>id <span class="token operator">=</span> ta<span class="token punctuation">.</span>id <span class="token operator">AND</span> tb<span class="token punctuation">.</span>name <span class="token operator">=</span> ta<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token comment"># 写法二</span>
<span class="token keyword">UPDATE</span> b <span class="token keyword">AS</span> tb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> create_time<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> a<span class="token punctuation">)</span> <span class="token keyword">AS</span> ta 
<span class="token keyword">SET</span> tb<span class="token punctuation">.</span>create_time <span class="token operator">=</span> ta<span class="token punctuation">.</span>create_time
<span class="token keyword">WHERE</span> tb<span class="token punctuation">.</span>id <span class="token operator">=</span> ta<span class="token punctuation">.</span>id <span class="token operator">AND</span> tb<span class="token punctuation">.</span>name <span class="token operator">=</span> ta<span class="token punctuation">.</span>name<span class="token punctuation">;</span></code></pre>

<p>所谓<strong>洗数据</strong>：在我的理解中，就是把旧数据，按照新数据的规则把旧数据不正确的值修改正确，同时把这些旧数据插入到新数据中，成为新数据。举个例子，A 表中的 province_id，值为 10 代表 广东，而 B 表中的 province_id ，值为 19 代表 广东，把 A 表中的数据插入到 B 表的过程中，把值为 10 修改为 19，这样插入的数据才能在 B 表中正确表示 广东，这个过程就是「洗数据」，当然，也可以在插入后再修改，不管过程是怎样，最终能把数据的值修改正确，就是洗数据！</p>
<p><strong>教训：</strong></p>
<ol>
<li><p><strong>数据量大的表，少在测试环境操作，要操作尽量保证写的 SQL 是正确的，能在本地环境操作就现在本地环境操作！</strong></p>
</li>
<li><p><strong>能用 Java 代码进行操作，优先写 Java 代码操作！</strong></p>
</li>
</ol>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">靓仔or靓女，可以请我喝杯咖啡吗？.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20220523221203.png"><img loading="lazy" src="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20220523221203.png" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20220523221130.png"><img loading="lazy" src="https://pic-bed-of-god23bin.oss-cn-shenzhen.aliyuncs.com/img/20220523221130.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>god23bin</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://god23bin.github.io/posts/thrilling-scene-of-working-with-MySQL/" title="我操作MySQL的惊险一幕">https://god23bin.github.io/posts/thrilling-scene-of-working-with-MySQL/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul><script>document.addEventListener('copy', function (event) {
  const clipboardData = event.clipboardData || window.clipboardData;
  if (!clipboardData) { return; }
  const text = window.getSelection().toString();
  if (text) {
    event.preventDefault();
    clipboardData.setData('text/plain', text + '\n\nPost author: god23bin\nPost link: https://god23bin.github.io/posts/thrilling-scene-of-working-with-MySQL/\nCopyright Notice: All articles in this blog are licensed under CC BY-NC-SA 4.0 unless otherwise stated.');
  }
});</script></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/posts/check-duplication-in-java/" rel="prev" title="噢！查重原来是这样实现的啊！"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">噢！查重原来是这样实现的啊！</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/posts/relearn-annotation/" rel="next" title="《回炉重造》——注解"><span class="post-nav-text">《回炉重造》——注解</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2021 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> god23bin</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v6.1.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.8.11</span></div><div class="live-time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-04-01T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} Days ${passHour} Hours ${passMinute} Minutes ${passSecond} Seconds`;
}
blog_live_time();
</script></div><div id="busuanzi"><span id="busuanzi_container_site_uv" title="Total Visitors"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-line"></use></svg></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="Total Views"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg></span><span id="busuanzi_value_site_pv"></span></span><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#6200ee" stroke-width="2" stroke-linecap="round"></circle></svg></a><script>function initMourn() {
  const date = new Date();
  const today = (date.getMonth() + 1) + "-" + date.getDate()
  const mourn_days = ["4-4","9-18"]
  if (mourn_days.includes(today)) {
    document.documentElement.style.filter = "grayscale(1)";
  }
}
initMourn();</script><div class="aplayer no-destroy" id="aplayer" data-id="140834718" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay data-theme="#6200ee" data-loop="all" data-order="list" data-preload="auto" data-volume="0.7" data-mutex data-lrctype="0" data-listmaxheight="340px" data-storagename="metingjs"></div></div></body></html>